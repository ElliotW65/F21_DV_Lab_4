<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Lab 4</title>

    <script src='https://d3js.org/d3.v7.min.js'></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; height: 100%; width: 100%; }
        #pop-up {width: 50%; height: 50%; position: absolute;}
        #pop-up-bar-chart {width: 90%; height: 90%; margin: auto;}
        #arcG {position: absolute; top: 10%; left: 25%;}
        .pie-year { font-family: Open Sans, sans-serif;
                    font-size: 30px;
                    font-weight: 700;
                    opacity: 0.5;}

    </style>
</head>
<body>
    <style>

        .node {
          cursor: pointer;
        }
        
        .node:hover {
          stroke: #000;
          stroke-width: 1.5px;
        }
        
        .node--leaf {
          fill: white;
        }
        
        .label {
          font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
          text-anchor: middle;
          text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
        }
        
        .label,
        .node--root,
        .node--leaf {
          pointer-events: none;
        }
        
        </style>
        <svg width="960" height="960"></svg>
        <script>
        
        var svg = d3.select("svg"),
            margin = 20,
            diameter = +svg.attr("width"),
            g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");
        
            var color = d3.scaleLinear().domain([-1,3])
                        .range(["rgb(34,139,34)", "white"])

        
        var pack = d3.pack()
            .size([diameter - margin, diameter - margin])
            .padding(2);
        
        d3.csv("renwable power split bp.csv").then(function(data) {

            console.log(data);

            function groupByCountry(data) {
                const newGroups = data.reduce(function(groups, item) {
                const group = (groups[item.Country] || []);
                group.push(item);
                groups[item.Country] = group;
                return groups;
                }, {});

                return newGroups;
            }

            function groupByYear(data) {
                const newGroups = data.reduce(function(groups, item) {
                const group = (groups[item.Year] || []);
                group.push(item);
                groups[item.Year] = group;
                return groups;
                }, {});

                return newGroups;
            }

            var data = groupByCountry(data);

            var data = groupByYear(data["United Kingdom"]);

            console.log(data);

            var displayData = data["2020"];

            console.log(displayData);

            displayData.forEach(d => {
                d.Value = +d.Value,
                d.PJ = +d.PJ,
                d.Value = isNaN(d.Value) ? 0 : d.Value,
                d.Year = +d.Year,
                d.colour = d3.hsl(Math.random()*360,0.75,0.75)
            })

            console.log(displayData);

            var nonRenewables = ["coal","gas","oil"]
            var renewables = ["hydro","biogeo","biofuels","solar","wind"]
            var hierarchy = {
                name : "total",
                children : [
                    {name: "non-renewables", children: [
                        {name: "fossil-fuels", children: [
                            {name: "coal", value: 0},
                            {name: "gas", value: 0},
                            {name: "oil", value: 0}
                        ],
                        value: 0},
                        {name: "other", children: [
                            {name: "nuclear", value: 0}
                        ],
                        value: 0}
                    ],
                    value: 0},
                    {name: "renewables", children: [
                        {name: "hydro", value: 0},
                        {name: "biogeo", value: 0},
                        {name: "biofuels", value: 0},
                        {name: "solar", value: 0},
                        {name: "wind", value: 0}
                    ],
                    value: 0}
                ],
                value: 0
            }

            var fossilTotal = 0;
            var otherTotal = 0;
            var renTotal = 0;

            for(i of displayData) {
                if(nonRenewables.includes(i.Category)) {
                    for(o of hierarchy.children[0].children[0].children) {
                        if(o.name == i.Category) {
                            o.value = i.PJ;
                            fossilTotal += i.PJ;
                        }
                        
                    }
                }
                else if(renewables.includes(i.Category)) {
                    for(o of hierarchy.children[1].children) {
                        if(o.name == i.Category) {
                            o.value = i.PJ;
                            renTotal += i.PJ;
                        }
                        
                    }
                }
                else if(i.Category == "nuclear") {
                    hierarchy.children[0].children[1].children.value = i.PJ;
                    otherTotal += i.PJ;
                }
            }

            hierarchy.children[0].children[0].value = fossilTotal;
            hierarchy.children[0].children[1].value = otherTotal;
            hierarchy.children[0].value = fossilTotal + otherTotal;
            hierarchy.children[1].value = renTotal;
            hierarchy.value = fossilTotal + otherTotal + renTotal;

            var data = hierarchy;

            console.log(data);
        
            var root = d3.hierarchy(data)
                .sum(function(d) { 
                    return d.value; 
                })
                .sort(function(a, b) { 
                    return b.value - a.value;
                });
            
            var zoomTarget = root,
                nodes = pack(root).descendants(),
                currentView;
            
            var circle = g.selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
/*                 .attr("class", function(d) {
                    console.log("depth: ", d);
                    if(d.depth == 1) {
                        return "node";
                    }
                    else if(d.depth == 2) {
                        console.log("2: ", d)
                        return "node node--leaf";
                    }
                    else if(d.depth == 3) {
                        console.log("depth2: ", d.depth);
                        return "node node--leaf";
                    }}) */
                .style("fill", function(d) { 
                    
                    if(d.children) {
                        return color(d.depth);
                    }
                    else {
                        return null;
                    }
                })
                .on("click", function(d) {
                    if (zoomTarget !== d.target.__data__) {
                        console.log("In true")
                        zoom(d)
                        d.stopPropagation();                    
                    }
                    
                });
            
            var text = g.selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "label")
                .style("fill-opacity", function(d) { 
                    
                    if(d.parent === root) {
                        return 1;
                    }
                    else {
                        return 0;
                    }
                })
                .style("display", function(d) { 
                    
                    if(d.parent === root) {
                        return "inline";
                    }
                    else {
                        return "none";
                    }
                })
                .text(function(d) { 
                    return d.data.name; 
                });
            
            var node = g.selectAll("circle,text");
            
            svg.on("click", function() { zoom(root); });
            
            zoomIn([root.x, root.y, root.r * 2 + margin]);
            
            function zoom(d) {
                var zoomTarget0 = zoomTarget;
                console.log("Zoom zoomTarget: ", d);
                if(d.depth == 0) {
                    zoomTarget = d
                }
                else if(d.target.__data__) {
                    zoomTarget = d.target.__data__;
                }
                

                console.log(zoomTarget);
            
                var zoom = d3.transition()
                    .duration(600)
                    .tween("zoom", function(d) {
                        var i = d3.interpolateZoom(currentView, [zoomTarget.x, zoomTarget.y, zoomTarget.r * 2 + margin]);
                        return function(t) { zoomIn(i(t)); };
                    });
            
                zoom.selectAll("text")
                    .filter(function(d) {
                        if(d.parent === zoomTarget) {
                            return d.parent === zoomTarget
                        }
                        else {
                            return this.style.display === "inline";
                        }
                        return d.parent === zoomTarget || this.style.display === "inline"; 
                    })
                    .style("fill-opacity", function(d) {
                        if(d.parent === zoomTarget) {
                            return 1;
                        }
                        else {
                            return 0;
                        }
                    })
                    .on("start", function(d) { 
                        if(d.parent === zoomTarget) {
                            this.style.display = "inline"
                        }
                    })
                    .on("end", function(d) { 
                        if (d.parent !== zoomTarget) {
                            this.style.display = "none";
                        } 
                    });
                }
            
            function zoomIn(v) {
                currentView = v;
                var p = diameter / v[2];
                currentView = v;
                node.attr("transform", function(d) { 
                    return "translate(" + (d.x - v[0]) * p + "," + (d.y - v[1]) * p + ")";
                });
                circle.attr("r", function(d) { 
                    return d.r * p; 
                });
            }
        });
        
    </script>

</body>
</html>

