<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Lab 4</title>

        <script src='https://d3js.org/d3.v7.min.js'></script>

        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; height: 100%; width: 100%; }
            #pop-up {width: 50%; height: 50%; position: absolute;}
            #pop-up-bar-chart {width: 90%; height: 90%; margin: auto;}
            #arcG {position: absolute; top: 10%; left: 25%;}
            .pie-year { font-family: Open Sans, sans-serif;
                        font-size: 30px;
                        font-weight: 700;
                        opacity: 0.5;}

        </style>

    <body>
        <div id="pop-up">
            <div id="pop-up-bar-chart"></div>
        </div>

        <script> 

            var link = "https://api.mapbox.com/geocoding/v5/mapbox.places/United%20Kingdom.json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ"

            function urlFormat(e) {
                //var coords = [e.lngLat.lng, e.lngLat.lat]

                return e;
            }

            function urlBuilder(country) {
                    var countryFormat = urlFormat(country);
                    var urlPrefix = "https://api.mapbox.com/geocoding/v5/mapbox.places/";
                    var accessToken = ".json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ";
                    return urlPrefix + countryFormat[0] + "," + countryFormat[1] + accessToken;
            }

            function httpGetAsync(country, callback) {
                var URL = urlBuilder(country);
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() { 
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        callback(xmlHttp.responseText, country);
                }
                xmlHttp.open("GET", URL, true); // true for asynchronous 
                xmlHttp.send(null);
            }


            function returnCenter(data) {
                
                const info = JSON.parse(data);

                for(i of info.features) {
                    if(i.place_type[0] == "country") {
                        var country = i.place_name;
                    }
                }

                console.log(country);
            }

            var svg = d3.select('body').append('svg')
                        .attr('width', '600px')
                        .attr('height', '600px')

            var g = svg.append("g")
                        .attr('transform', 'translate(' + 600/2 +  ',' + 600/2 +')');

            d3.csv('renwable power split bp.csv').then(function(data) {

                console.log(data);

                function groupByCountry(data) {
                    const newGroups = data.reduce(function(groups, item) {
                    const group = (groups[item.Country] || []);
                    group.push(item);
                    groups[item.Country] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                function groupByYear(data) {
                    const newGroups = data.reduce(function(groups, item) {
                    const group = (groups[item.Year] || []);
                    group.push(item);
                    groups[item.Year] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                var data = groupByCountry(data);

                var data = groupByYear(data["United Kingdom"]);

                console.log(data);

                var displayData = data["2020"];

                console.log(displayData);

                displayData.forEach(d => {
                    d.Value = +d.Value,
                    d.PJ = +d.PJ,
                    d.Value = isNaN(d.Value) ? 0 : d.Value,
                    d.Year = +d.Year,
                    d.colour = d3.hsl(Math.random()*360,0.75,0.75)
                })

                console.log(displayData);

                var nonRenewables = ["coal","gas","oil"]
                var renewables = ["hydro","biogeo","biofuels","solar","wind"]
                var hierarchy = {
                    name : "total",
                    children : [
                        {name: "non-renewables", children: [
                            {name: "fossil-fuels", children: [
                                {name: "coal", value: 0},
                                {name: "gas", value: 0},
                                {name: "oil", value: 0}
                            ]},
                            {name: "other", children: [
                                {name: "nuclear", value: 0}
                            ]}
                        ]},
                        {name: "renewables", children: [
                            {name: "hydro", value: 0},
                            {name: "biogeo", value: 0},
                            {name: "biofuels", value: 0},
                            {name: "solar", value: 0},
                            {name: "wind", value: 0}
                        ]}
                    ]
                }

                for(i of displayData) {
                    if(nonRenewables.includes(i.Category)) {
                        for(o of hierarchy.children[0].children[0].children) {
                            if(o.name == i.Category) {
                                o.value = i.PJ;
                            }
                        }
                    }
                    else if(renewables.includes(i.Category)) {
                        for(o of hierarchy.children[1].children) {
                            if(o.name == i.Category) {
                                o.value = i.PJ;
                            }
                        }
                    }
                    else if(i.Category == "nuclear") {
                        hierarchy.children[0].children[1].children.value = i.PJ;
                    }
                }

                console.log(hierarchy);

                

            });


        </script>

    </head>