<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Lab 4</title>

        <script src='https://d3js.org/d3.v7.min.js'></script>

        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; height: 100%; width: 100%; }
            #pop-up {width: 50%; height: 50%; position: absolute;}
            #pop-up-bar-chart {width: 90%; height: 90%; margin: auto;}
            #arcG {position: absolute; top: 10%; left: 25%;}
            .pie-year { font-family: Open Sans, sans-serif;
                        font-size: 30px;
                        font-weight: 700;
                        opacity: 0.5;}

        </style>

    <body>
        <div id="pop-up">
            <div id="pop-up-bar-chart"></div>
        </div>

        <script> 

            var link = "https://api.mapbox.com/geocoding/v5/mapbox.places/United%20Kingdom.json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ"

            function urlFormat(e) {
                //var coords = [e.lngLat.lng, e.lngLat.lat]

                return e;
            }

            function urlBuilder(country) {
                    var countryFormat = urlFormat(country);
                    var urlPrefix = "https://api.mapbox.com/geocoding/v5/mapbox.places/";
                    var accessToken = ".json?access_token=pk.eyJ1IjoiZWxsaW90dzY1IiwiYSI6ImNrbGk0amV4MTA5bHUycW5tN2JzM3J0bTIifQ.OGT4ltSNZ7vyd_yEUg8afQ";
                    return urlPrefix + countryFormat[0] + "," + countryFormat[1] + accessToken;
            }

            function httpGetAsync(country, callback) {
                var URL = urlBuilder(country);
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() { 
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        callback(xmlHttp.responseText, country);
                }
                xmlHttp.open("GET", URL, true); // true for asynchronous 
                xmlHttp.send(null);
            }


            function returnCenter(data) {
                
                const info = JSON.parse(data);

                for(i of info.features) {
                    if(i.place_type[0] == "country") {
                        var country = i.place_name;
                    }
                }

                console.log(country);
            }

/*             var svg = d3.select('body').append('svg')
                        .attr('width', '600px')
                        .attr('height', '600px')

            var g = svg.append("g")
                        .attr('transform', 'translate(' + 600/2 +  ',' + 600/2 +')'); */

            d3.csv('renwable power split bp.csv').then(function(data) {

                console.log(data);

                function groupByCountry(data) {
                    const newGroups = data.reduce(function(groups, item) {
                    const group = (groups[item.Country] || []);
                    group.push(item);
                    groups[item.Country] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                function groupByYear(data) {
                    const newGroups = data.reduce(function(groups, item) {
                    const group = (groups[item.Year] || []);
                    group.push(item);
                    groups[item.Year] = group;
                    return groups;
                    }, {});

                    return newGroups;
                }

                var data = groupByCountry(data);

                var data = groupByYear(data["United Kingdom"]);

                console.log(data);

                var displayData = data["2020"];

                console.log(displayData);

                displayData.forEach(d => {
                    d.Value = +d.Value,
                    d.PJ = +d.PJ,
                    d.Value = isNaN(d.Value) ? 0 : d.Value,
                    d.Year = +d.Year,
                    d.colour = d3.hsl(Math.random()*360,0.75,0.75)
                })

                console.log(displayData);

                var nonRenewables = ["coal","gas","oil"]
                var renewables = ["hydro","biogeo","biofuels","solar","wind"]
                var hierarchy = {
                    name : "total",
                    children : [
                        {name: "non-renewables", children: [
                            {name: "fossil-fuels", children: [
                                {name: "coal", value: 0},
                                {name: "gas", value: 0},
                                {name: "oil", value: 0}
                            ],
                            value: 0},
                            {name: "other", children: [
                                {name: "nuclear", value: 0}
                            ],
                            value: 0}
                        ],
                        value: 0},
                        {name: "renewables", children: [
                            {name: "hydro", value: 0},
                            {name: "biogeo", value: 0},
                            {name: "biofuels", value: 0},
                            {name: "solar", value: 0},
                            {name: "wind", value: 0}
                        ],
                        value: 0}
                    ],
                    value: 0
                }

                var fossilTotal = 0;
                var otherTotal = 0;
                var renTotal = 0;

                for(i of displayData) {
                    if(nonRenewables.includes(i.Category)) {
                        for(o of hierarchy.children[0].children[0].children) {
                            if(o.name == i.Category) {
                                o.value = i.PJ;
                                fossilTotal += i.PJ;
                            }
                            
                        }
                    }
                    else if(renewables.includes(i.Category)) {
                        for(o of hierarchy.children[1].children) {
                            if(o.name == i.Category) {
                                o.value = i.PJ;
                                renTotal += i.PJ;
                            }
                            
                        }
                    }
                    else if(i.Category == "nuclear") {
                        hierarchy.children[0].children[1].children.value = i.PJ;
                        otherTotal += i.PJ;
                    }
                }

                console.log("Fossil total: " ,renTotal);

                console.log(hierarchy);

                var data = hierarchy;

                pack = data => d3.pack()
                    .size([width, height])
                    .padding(3)
                (d3.hierarchy(data)
                    .sum(function(d) {
                        console.log("d: ", d);
                        console.log("d value: ", d.value);
                        return d.value;
                    })
                    .sort((a, b) => b.value - a.value))

                const root = pack(data);
                let focus = root;
                let view;

                var width = 932

                var height = width


                var color = d3.scaleLinear()
                    .domain([0, 5])
                    .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
                    .interpolate(d3.interpolateHcl)

                const svg = d3.select("body")
                    .append('svg')
                    .attr("viewBox", `-${width / 2} -${height / 2} ${width} ${height}`)
                    .style("display", "block")
                    .style("margin", "0 -14px")
                    .style("background", color(0))
                    .style("cursor", "pointer")
                    .on("click", (event) => zoom(event, root));

                console.log("root: ", root);

                const node = svg.append("g")
                    .selectAll("circle")
                    .data(root.descendants().slice(1))
                    .join("circle")
                    .attr("fill", d => d.children ? color(d.depth) : "white")
                    .attr("pointer-events", d => !d.children ? "none" : null)
                    .on("mouseover", function() { d3.select(this).attr("stroke", "#000"); })
                    .on("mouseout", function() { d3.select(this).attr("stroke", null); })
                    .on("click", (event, d) => focus !== d && (zoom(event, d), event.stopPropagation()));

                const label = svg.append("g")
                    .style("font", "10px sans-serif")
                    .attr("pointer-events", "none")
                    .attr("text-anchor", "middle")
                    .selectAll("text")
                    .data(root.descendants())
                    .join("text")
                    .style("fill-opacity", d => d.parent === root ? 1 : 0)
                    .style("display", d => d.parent === root ? "inline" : "none")
                    .text(d => d.data.name);

                zoomTo([root.x, root.y, root.r * 2]);

                function zoomTo(v) {
                    const k = width / v[2];

                    view = v;

                    label.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
                    node.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
                    node.attr("r", d => d.r * k);
                }

                function zoom(event, d) {
                    const focus0 = focus;

                    focus = d;

                    const transition = svg.transition()
                        .duration(event.altKey ? 7500 : 750)
                        .tween("zoom", d => {
                        const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
                        return t => zoomTo(i(t));
                        });

                    label
                    .filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
                    .transition(transition)
                        .style("fill-opacity", d => d.parent === focus ? 1 : 0)
                        .on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
                        .on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
                }

                return svg.node();




                

            });


        </script>

    </head>